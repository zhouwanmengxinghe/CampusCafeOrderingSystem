@{
    ViewData["Title"] = "Reports";
}

<h2 class="mb-4 text-center">?? System Reports</h2>

<!-- Filters -->
<div class="card shadow-sm mb-3">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-12 col-md-3">
                <label class="form-label">From</label>
                <input type="date" id="fromDate" class="form-control" />
            </div>
            <div class="col-12 col-md-3">
                <label class="form-label">To</label>
                <input type="date" id="toDate" class="form-control" />
            </div>
            <div class="col-12 col-md-3">
                <button id="resetFilters" class="btn btn-outline-secondary w-100">Reset</button>
            </div>
        </div>
    </div>
</div>

<!-- Overview Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
        <div class="card shadow-sm text-center p-3">
            <div class="text-muted small">Total Orders</div>
            <div id="kpiOrders" class="fs-2 fw-bold text-primary">0</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="card shadow-sm text-center p-3">
            <div class="text-muted small">Total Revenue</div>
            <div id="kpiRevenue" class="fs-2 fw-bold text-success">$0</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="card shadow-sm text-center p-3">
            <div class="text-muted small">New Users</div>
            <div id="kpiUsers" class="fs-2 fw-bold text-warning">0</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="card shadow-sm text-center p-3">
            <div class="text-muted small">Pending Orders</div>
            <div id="kpiPending" class="fs-2 fw-bold text-danger">0</div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row g-3 mb-4">
    <div class="col-12 col-lg-7">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title mb-3">Revenue Trend</h5>
                <canvas id="revenueChart" height="120"></canvas>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-5">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title mb-3">Orders Trend</h5>
                <canvas id="ordersChart" height="120"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Data Table -->
<div class="card shadow-sm">
    <div class="card-body">
        <h5 class="card-title">Sales Summary</h5>
        <div class="table-responsive">
            <table id="reportsTable" class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Date</th>
                        <th>Total Orders</th>
                        <th>Total Revenue</th>
                        <th>New Users</th>
                        <th>Pending Orders</th>
                    </tr>
                </thead>
                <tbody id="tbodyData">
                    @* 由 JS 渲染 *@
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <!-- DataTables + Buttons (如全局已引入，可移除以下 5 行) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

    <!-- Chart.js (如全局已引入，可移除) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // -------- Data (Single Source of Truth) --------
        const currency = 'USD'; // 如需改成 NZD：'NZD'
        const rows = [
            { date: '2025-08-01', orders: 45, revenue: 450.00, users: 5, pending: 1 },
            { date: '2025-08-02', orders: 38, revenue: 380.00, users: 3, pending: 2 },
            { date: '2025-08-03', orders: 52, revenue: 520.00, users: 7, pending: 1 },
            { date: '2025-08-04', orders: 41, revenue: 410.00, users: 4, pending: 0 },
            { date: '2025-08-05', orders: 50, revenue: 500.00, users: 6, pending: 3 }
        ];

        // -------- Helpers --------
        const fmtCurrency = (n) => new Intl.NumberFormat(undefined, { style: 'currency', currency }).format(n);
        const parseDate = (s) => new Date(s + 'T00:00:00');

        function applyDateFilter(data) {
            const from = document.getElementById('fromDate').value;
            const to = document.getElementById('toDate').value;
            const fromD = from ? parseDate(from) : null;
            const toD = to ? parseDate(to) : null;

            return data.filter(r => {
                const d = parseDate(r.date);
                if (fromD && d < fromD) return false;
                if (toD && d > toD) return false;
                return true;
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('tbodyData');
            tbody.innerHTML = data.map(r => `
                    <tr>
                        <td>${r.date}</td>
                        <td>${r.orders}</td>
                        <td>${fmtCurrency(r.revenue)}</td>
                        <td>${r.users}</td>
                        <td>${r.pending}</td>
                    </tr>
                `).join('');
        }

        function updateKPIs(data) {
            const sum = (key) => data.reduce((a, b) => a + (b[key] ?? 0), 0);
            document.getElementById('kpiOrders').textContent = sum('orders').toLocaleString();
            document.getElementById('kpiRevenue').textContent = fmtCurrency(sum('revenue'));
            document.getElementById('kpiUsers').textContent = sum('users').toLocaleString();
            document.getElementById('kpiPending').textContent = sum('pending').toLocaleString();
        }

        let dt; // DataTable instance
        let revenueChart, ordersChart;

        function initDataTable() {
            if (dt) { dt.destroy(); }
            dt = $('#reportsTable').DataTable({
                pageLength: 10,
                order: [[0, 'desc']],
                dom: 'Bfrtip',
                buttons: [
                    { extend: 'csv', title: 'reports' },
                    { extend: 'excel', title: 'reports' },
                    { extend: 'print', title: 'System Reports' }
                ],
                columnDefs: [
                    { targets: 0, type: 'date' }
                ]
            });
        }

        function renderCharts(data) {
            const labels = data.map(r => r.date);
            const revenue = data.map(r => r.revenue);
            const orders = data.map(r => r.orders);

            // Destroy old
            if (revenueChart) revenueChart.destroy();
            if (ordersChart) ordersChart.destroy();

            // Revenue line (with gradient)
            const ctx1 = document.getElementById('revenueChart').getContext('2d');
            const grad = ctx1.createLinearGradient(0, 0, 0, 200);
            grad.addColorStop(0, 'rgba(76, 175, 80, 0.35)');  // brand green-ish
            grad.addColorStop(1, 'rgba(76, 175, 80, 0.05)');

            revenueChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: `Revenue (${currency})`,
                        data: revenue,
                        fill: true,
                        backgroundColor: grad,
                        borderColor: 'rgba(76, 175, 80, 1)',
                        tension: 0.3,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: {
                            ticks: {
                                callback: (v) => fmtCurrency(v)
                            }
                        }
                    }
                }
            });

            // Orders bar
            const ctx2 = document.getElementById('ordersChart').getContext('2d');
            ordersChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Orders',
                        data: orders,
                        backgroundColor: 'rgba(33, 150, 243, 0.35)',
                        borderColor: 'rgba(33, 150, 243, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });
        }

        function refreshAll() {
            const filtered = applyDateFilter(rows);
            renderTable(filtered);
            updateKPIs(filtered);
            initDataTable(); // re-init DT after re-render
            renderCharts(filtered);
        }

        // Init
        $(function () {
            // 默认填充 To = 最大日期
            const maxDate = rows.reduce((max, r) => r.date > max ? r.date : max, rows[0].date);
            $('#toDate').val(maxDate);

            refreshAll();

            $('#fromDate, #toDate').on('change', refreshAll);
            $('#resetFilters').on('click', function () {
                $('#fromDate').val('');
                $('#toDate').val(maxDate);
                refreshAll();
            });
        });
    </script>
}
