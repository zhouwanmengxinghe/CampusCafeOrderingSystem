@model List<CampusCafeOrderingSystem.Models.Order>
@{
    ViewData["Title"] = "Order Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-primary">
                    <i class="fas fa-clipboard-list"></i> Order Management
                </h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="refreshOrders()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="filterOrders('all')">All Orders</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterOrders('pending')">Pending</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterOrders('confirmed')">Confirmed</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterOrders('preparing')">Preparing</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterOrders('ready')">Ready</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterOrders('completed')">Completed</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            @if (TempData["Toast"] != null)
            {
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    @TempData["Toast"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <!-- Orders Table -->
            <div class="card">
                <div class="card-body">
                    @if (Model == null || !Model.Any())
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted">No Orders Found</h4>
                            <p class="text-muted">There are no orders to display at the moment.</p>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover" id="ordersTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Order #</th>
                                        <th>Customer</th>
                                        <th>Date</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th>Est. Time</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var order in Model)
                                    {
                                        <tr data-order-id="@order.Id" data-status="@order.Status.ToString().ToLower()">
                                            <td>
                                                <strong>@order.OrderNumber</strong>
                                                <br>
                                                <small class="text-muted">ID: @order.Id</small>
                                            </td>
                                            <td>
                                                @if (order.User != null)
                                                {
                                                    <div>
                                                        <strong>@order.User.UserName</strong>
                                                        <br>
                                                        <small class="text-muted">@order.User.Email</small>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Unknown User</span>
                                                }
                                            </td>
                                            <td>
                                                @order.OrderDate.ToString("MM/dd HH:mm")
                                                <br>
                                                <small class="text-muted">@order.PaymentMethod</small>
                                            </td>
                                            <td>
                                                <div class="order-items">
                                                    @foreach (var item in order.OrderItems.Take(2))
                                                    {
                                                        <div class="small">
                                                            @item.Quantity × @item.MenuItemName
                                                        </div>
                                                    }
                                                    @if (order.OrderItems.Count > 2)
                                                    {
                                                        <small class="text-muted">+@(order.OrderItems.Count - 2) more...</small>
                                                    }
                                                </div>
                                            </td>
                                            <td>
                                                <strong>NZ$@order.TotalAmount.ToString("F2")</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-@GetStatusColor(order.Status)">
                                                    @order.Status
                                                </span>
                                                @if (order.Status == CampusCafeOrderingSystem.Models.OrderStatus.Preparing && order.EstimatedCompletionTime.HasValue)
                                                {
                                                    <br>
                                                    <small class="text-info">
                                                        <i class="fas fa-clock"></i> @order.EstimatedCompletionTime.Value.ToString("HH:mm")
                                                    </small>
                                                }
                                            </td>
                                            <td>
                                                @if (order.EstimatedCompletionTime.HasValue)
                                                {
                                                    <small class="text-muted">
                                                        @order.EstimatedCompletionTime.Value.ToString("HH:mm")
                                                    </small>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                <div class="btn-group-vertical btn-group-sm" role="group">
                                                    <button class="btn btn-outline-success btn-sm" data-action="Confirmed" onclick="updateStatus(@order.Id, 'Confirmed')">
                                                        <i class="fas fa-check"></i> Confirm
                                                    </button>
                                                    <button class="btn btn-outline-primary btn-sm" data-action="Preparing" onclick="updateStatus(@order.Id, 'Preparing')">
                                                        <i class="fas fa-utensils"></i> Start Preparing
                                                    </button>
                                                    <button class="btn btn-outline-info btn-sm" data-action="SetTime" onclick="setEstimatedTime(@order.Id)">
                                                        <i class="fas fa-clock"></i> Set Time
                                                    </button>
                                                    <button class="btn btn-outline-warning btn-sm" data-action="Ready" onclick="updateStatus(@order.Id, 'Ready')">
                                                        <i class="fas fa-bell"></i> Ready for Pickup
                                                    </button>
                                                    <button class="btn btn-outline-success btn-sm" data-action="Completed" onclick="updateStatus(@order.Id, 'Completed')">
                                                        <i class="fas fa-thumbs-up"></i> Complete
                                                    </button>
                                                    <button class="btn btn-outline-danger btn-sm" data-action="Cancelled" onclick="updateStatus(@order.Id, 'Cancelled')">
                                                        <i class="fas fa-times"></i> Cancel
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Set Estimated Time Modal -->
<div class="modal fade" id="estimatedTimeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Estimated Completion Time</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="estimatedTimeForm">
                    <input type="hidden" id="orderIdInput" />
                    <div class="mb-3">
                        <label for="minutesInput" class="form-label">Estimated minutes from now:</label>
                        <select class="form-select" id="minutesInput" required>
                            <option value="5">5 minutes</option>
                            <option value="10">10 minutes</option>
                            <option value="15" selected>15 minutes</option>
                            <option value="20">20 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="45">45 minutes</option>
                            <option value="60">1 hour</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEstimatedTime()">Set</button>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetStatusColor(CampusCafeOrderingSystem.Models.OrderStatus status)
    {
        return status switch
        {
            CampusCafeOrderingSystem.Models.OrderStatus.Pending => "warning",
            CampusCafeOrderingSystem.Models.OrderStatus.Confirmed => "info",
            CampusCafeOrderingSystem.Models.OrderStatus.Preparing => "primary",
            CampusCafeOrderingSystem.Models.OrderStatus.Ready => "success",
            CampusCafeOrderingSystem.Models.OrderStatus.Completed => "success",
            CampusCafeOrderingSystem.Models.OrderStatus.Cancelled => "danger",
            _ => "secondary"
        };
    }
}

<script>
// Simple confirm dialog (Bootstrap 5)
function showConfirmDialog(title, message, onConfirm) {
    const modalEl = document.createElement('div');
    modalEl.className = 'modal fade';
    modalEl.tabIndex = -1;
    modalEl.innerHTML = `
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">${title || 'Confirm Action'}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>${message || ''}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="__confirmOkBtn">Confirm</button>
        </div>
      </div>
    </div>`;
    document.body.appendChild(modalEl);
    const modal = new bootstrap.Modal(modalEl);
    const okBtn = modalEl.querySelector('#__confirmOkBtn');
    okBtn.addEventListener('click', function() {
        try { if (typeof onConfirm === 'function') onConfirm(); } finally { modal.hide(); }
    });
    modalEl.addEventListener('hidden.bs.modal', function() {
        modal.dispose();
        modalEl.remove();
    });
    modal.show();
}

function performUpdateStatus(orderId, status) {
    const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
    const token = tokenInput ? tokenInput.value : null;
    const url = '@Url.Action("UpdateOrderStatus", "Admin")';

    const body = new URLSearchParams();
    body.append('orderId', orderId);
    body.append('status', status);
    if (token) body.append('__RequestVerificationToken', token);

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
            ...(token ? { 'RequestVerificationToken': token } : {})
        },
        body: body.toString()
    })
    .then(res => res.ok ? res.json() : res.text().then(t => { throw new Error(t || res.statusText); }))
    .then(data => {
        const ok = (data && (data.success === true || data.isSuccess === true || (data.data && data.data.success === true))) ? true : false;
        const msg = (data && (data.message || (data.data && data.data.message))) || 'Order status updated successfully';
        if (ok) {
            showInlineToast('success', msg);
            applyOrderStatusChange(orderId, status);
        } else {
            showInlineToast('danger', msg || 'Update failed');
        }
    })
    .catch(err => {
        console.error('Update status failed:', err);
        showInlineToast('danger', 'Request failed: ' + err.message);
    });
}

function updateStatus(orderId, status) {
    const statusTextMap = { Confirmed: 'Confirm', Preparing: 'Start Preparing', Ready: 'Ready for Pickup', Completed: 'Complete', Cancelled: 'Cancel' };
    const text = statusTextMap[status] || status;
    showConfirmDialog('Confirm Action', `Are you sure you want to change the order status to "${text}"?`, function(){
        performUpdateStatus(orderId, status);
    });
}

// 初始化每行按钮的显示/隐藏
function initializeRowActionButtons() {
    const rows = document.querySelectorAll('#ordersTable tbody tr');
    rows.forEach(row => {
        const id = row.getAttribute('data-order-id');
        const statusLower = (row.dataset.status || '').trim();
        if (!id || !statusLower) return;
        const status = statusLower.charAt(0).toUpperCase() + statusLower.slice(1);
        applyOrderStatusChange(id, status);
    });
}

// DOMContentLoaded 时初始化按钮可见性
document.addEventListener('DOMContentLoaded', function(){
    if (document.getElementById('ordersTable')) {
        initializeRowActionButtons();
    }
});

function setEstimatedTime(orderId) {
    document.getElementById('orderIdInput').value = orderId;
    new bootstrap.Modal(document.getElementById('estimatedTimeModal')).show();
}

function submitEstimatedTime() {
    const orderId = document.getElementById('orderIdInput').value;
    const minutes = document.getElementById('minutesInput').value;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '@Url.Action("SetEstimatedTime", "Admin")';
    
    const orderIdInput = document.createElement('input');
    orderIdInput.type = 'hidden';
    orderIdInput.name = 'orderId';
    orderIdInput.value = orderId;
    
    const minutesInput = document.createElement('input');
    minutesInput.type = 'hidden';
    minutesInput.name = 'minutes';
    minutesInput.value = minutes;
    
    const tokenInput = document.createElement('input');
    tokenInput.type = 'hidden';
    tokenInput.name = '__RequestVerificationToken';
    tokenInput.value = $('input[name="__RequestVerificationToken"]').val();
    
    form.appendChild(orderIdInput);
    form.appendChild(minutesInput);
    form.appendChild(tokenInput);
    
    document.body.appendChild(form);
    form.submit();
    
    bootstrap.Modal.getInstance(document.getElementById('estimatedTimeModal')).hide();
}

function filterOrders(status) {
    const rows = document.querySelectorAll('#ordersTable tbody tr');
    rows.forEach(row => {
        if (status === 'all' || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function refreshOrders() {
    location.reload();
}

// Helpers: inline toast + apply UI changes without page reload
function showInlineToast(variant, text) {
    const alert = document.createElement('div');
    const variantClass = {
        success: 'alert-success',
        info: 'alert-info',
        warning: 'alert-warning',
        danger: 'alert-danger'
    }[variant] || 'alert-info';

    alert.className = `alert ${variantClass} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 320px;';
    alert.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas ${variant === 'success' ? 'fa-check-circle' : variant === 'danger' ? 'fa-exclamation-triangle' : 'fa-info-circle'} me-2"></i>
            <div>${text}</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => { alert.classList.remove('show'); alert.addEventListener('transitionend', () => alert.remove()); }, 3000);
}

function applyOrderStatusChange(orderId, status) {
    const row = document.querySelector(`#ordersTable tbody tr[data-order-id="${orderId}"]`);
    if (!row) return;
    // Update badge text and color
    const badge = row.querySelector('.badge');
    if (badge) {
        const colorMap = { Pending: 'warning', Confirmed: 'info', Preparing: 'primary', Ready: 'success', Completed: 'success', Cancelled: 'danger' };
        badge.className = badge.className.replace(/\bbg-\w+\b/g, '').trim();
        badge.classList.add('bg-' + (colorMap[status] || 'secondary'));
        badge.textContent = status;
    }
    // Update data-status for filtering
    row.dataset.status = (status || '').toLowerCase();

    // Toggle action buttons visibility according to new status
    const group = row.querySelector('.btn-group-vertical');
    if (group) {
        const visibleActions = {
            Pending: ['Confirmed', 'Cancelled'],
            Confirmed: ['Preparing', 'SetTime', 'Cancelled'],
            Preparing: ['Ready', 'Cancelled'],
            Ready: ['Completed', 'Cancelled'],
            Completed: [],
            Cancelled: []
        };
        const allowed = new Set(visibleActions[status] || []);
        group.querySelectorAll('button[data-action]').forEach(btn => {
            const action = btn.getAttribute('data-action');
            btn.style.display = allowed.has(action) ? '' : 'none';
        });
    }
}

// SignalR connection
let signalRConnection;

// Initialize SignalR connection
function adminInitSignalR() {
    signalRConnection = new window.signalR.HubConnectionBuilder()
        .withUrl("/orderHub")
        .build();

    // Listen for new order events
    signalRConnection.on("NewOrder", function (orderData) {
        console.log('New order received (Admin):', orderData);
        showNewOrderNotification(orderData);
        setTimeout(() => {
            location.reload();
        }, 1000);
    });

    // Listen for order status update events
    signalRConnection.on("OrderStatusUpdated", function (orderData) {
        console.log('Order status updated (Admin):', orderData);
        showStatusUpdateNotification(orderData);
        var id = (orderData && (orderData.orderId || orderData.id || orderData.orderID || orderData.OrderId || orderData.OrderID));
        var newStatus = (orderData && (orderData.status || orderData.newStatus || orderData.Status || orderData.NewStatus));
        if (id && newStatus) {
            applyOrderStatusChange(id, newStatus);
        }
    });

    // Listen for estimated time updates
    signalRConnection.on("EstimatedTimeUpdated", function (orderData) {
        console.log('Estimated time updated (Admin):', orderData);
        showTimeUpdateNotification(orderData);
        setTimeout(() => {
            location.reload();
        }, 1000);
    });

    // Start connection
    signalRConnection.start().then(function () {
        console.log("SignalR connection established for Admin Orders");
        signalRConnection.invoke("JoinAdminGroup");
    }).catch(function (err) {
        console.error("SignalR connection failed:", err);
    });
}

// Show new order notification
function showNewOrderNotification(orderData) {
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 350px;';
    const amount = (orderData && orderData.totalAmount) ? Number(orderData.totalAmount).toFixed(2) : '0.00';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-plus-circle me-2"></i>
            <div>
                <strong>A new order has been created!</strong><br>
                Order #: ${orderData && (orderData.orderNumber || orderData.OrderNumber || '')}<br>
                <small class="text-muted">Vendor: ${orderData && (orderData.vendorEmail || orderData.VendorEmail || '')}</small>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    setTimeout(() => { if (notification.parentNode) notification.remove(); }, 8000);
}

// Show status update notification
function showStatusUpdateNotification(orderData) {
    const notification = document.createElement('div');
    notification.className = 'alert alert-warning alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 350px;';
    const oldS = orderData && (orderData.oldStatus || orderData.OldStatus || '');
    const newS = orderData && (orderData.status || orderData.newStatus || orderData.Status || orderData.NewStatus || '');
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-sync-alt me-2"></i>
            <div>
                <strong>Order status updated!</strong><br>
                Order #: ${orderData && (orderData.orderNumber || orderData.OrderNumber || '')}<br>
                <small class="text-muted">New Status: ${orderData && (orderData.status || orderData.Status || '')}</small>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    setTimeout(() => { if (notification.parentNode) notification.remove(); }, 6000);
}

// Show time update notification
function showTimeUpdateNotification(orderData) {
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 350px;';
    const minutes = orderData && (orderData.minutes || orderData.Minutes || '');
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-clock me-2"></i>
            <div>
                <strong>Estimated completion time updated!</strong><br>
                Order #: ${orderData && (orderData.orderNumber || orderData.OrderNumber || '')}<br>
                <small class="text-muted">ETA: ${minutes} minutes</small>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    setTimeout(() => { if (notification.parentNode) notification.remove(); }, 5000);
}
// Initialize SignalR when page loads
document.addEventListener('DOMContentLoaded', function() {
    try {
        if (window.signalR && typeof window.signalR.HubConnectionBuilder === 'function') {
            adminInitSignalR();
        } else {
            console.warn('SignalR client not found, attempting to load from CDN...');
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js';
            script.async = true;
            script.onload = function() {
                try {
                    if (window.signalR && typeof window.signalR.HubConnectionBuilder === 'function') {
                        adminInitSignalR();
                    } else {
                        console.warn('SignalR still unavailable after loading script.');
                    }
                } catch (e) {
                    console.warn('SignalR init after load failed:', e);
                }
            };
            script.onerror = function() {
                console.warn('Failed to load SignalR script from CDN. Real-time updates disabled for this page.');
            };
            document.head.appendChild(script);
        }
    } catch (e) {
        console.warn('SignalR init skipped due to error:', e);
    }
});

// Auto-refresh every 60 seconds as fallback (reduced frequency since we have real-time updates)
setInterval(function() {
    let connected = false;
    try {
        connected = !!(window.signalR && window.signalR.HubConnectionState && signalRConnection && signalRConnection.state === window.signalR.HubConnectionState.Connected);
    } catch (e) {
        connected = false;
    }
    if (!connected) {
        location.reload();
    }
}, 60000);
</script>

<style>
.order-items {
    max-width: 200px;
}

.btn-group-vertical .btn {
    margin-bottom: 2px;
}

.table td {
    vertical-align: middle;
}

.badge {
    font-size: 0.75em;
}
</style>