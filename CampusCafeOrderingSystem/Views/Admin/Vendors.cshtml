@using System.Linq
@model IEnumerable<CampusCafeOrderingSystem.Models.ViewModels.VendorViewModel>
@using CampusCafeOrderingSystem.Models.ViewModels

    @{
    ViewData["Title"] = "Vendor Management";

    int total    = Model?.Count() ?? 0;
    int active   = Model?.Count(v => v.Status == "Active") ?? 0;
    int pending  = Model?.Count(v => v.Status == "Pending") ?? 0;
    int disabled = Model?.Count(v => v.Status == "Disabled") ?? 0;

    string Badge(string s) => s switch
    {
        "Active"   => "<span class=\"badge bg-success\">Active</span>",
        "Pending"  => "<span class=\"badge bg-secondary\">Pending</span>",
        "Disabled" => "<span class=\"badge bg-warning text-dark\">Disabled</span>",
        "Rejected" => "<span class=\"badge bg-danger\">Rejected</span>",
        _          => "<span class=\"badge bg-light text-dark\">Unknown</span>"
    };

    string Stars(decimal r)
    {
        var full = (int)Math.Round(r, MidpointRounding.AwayFromZero);
        full = Math.Min(5, Math.Max(0, full));
        return new string('★', full) + new string('☆', 5 - full);
    }
    }

    <div class="container my-4">
        <h2 class="mb-4 text-center">Vendor Management</h2>
        
        @* Add anti-forgery token for JavaScript use *@
        @Html.AntiForgeryToken()

        @if (TempData["VendorToast"] is string toast && !string.IsNullOrWhiteSpace(toast))
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            @toast
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

     
        <div class="row g-3 mb-3">
            <div class="col-6 col-md-3">
                <div class="card shadow-sm text-center p-3">
                    <div class="text-muted small">Total Vendors</div>
                    <div class="fs-3 fw-bold">@total</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card shadow-sm text-center p-3">
                    <div class="text-muted small">Active</div>
                    <div class="fs-3 fw-bold text-success">@active</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card shadow-sm text-center p-3">
                    <div class="text-muted small">Pending</div>
                    <div class="fs-3 fw-bold text-secondary">@pending</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card shadow-sm text-center p-3">
                    <div class="text-muted small">Disabled</div>
                    <div class="fs-3 fw-bold text-warning">@disabled</div>
                </div>
            </div>
        </div>

      
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Keyword</label>
                        <input id="searchBox" type="text" class="form-control" placeholder="Search name / email / phone">
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">Status</label>
                        <select id="statusFilter" class="form-select">
                            <option value="">All</option>
                            <option value="Active">Active</option>
                            <option value="Pending">Pending</option>
                            <option value="Disabled">Disabled</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">Min Rating</label>
                        <select id="ratingFilter" class="form-select">
                            <option value="">All</option>
                            <option value="1">1 Star</option>
                            <option value="2">2 Stars</option>
                            <option value="3">3 Stars</option>
                            <option value="4">4 Stars</option>
                            <option value="5">5 Stars</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-2 text-md-end">
                        <button id="resetFilters" class="btn btn-outline-secondary w-100">Reset</button>
                    </div>
                </div>
            </div>
        </div>

       
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="vendorsTable" class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th style="width:90px;">Vendor ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th style="width:110px;">Status</th>
                                <th style="width:140px;">Registered</th>
                                <th style="width:120px;">Rating</th>
                                <th style="width:180px;" class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var v in Model ?? Enumerable.Empty<CampusCafeOrderingSystem.Models.ViewModels.VendorViewModel>())
                        {
                            <tr>
                                <td>@v.Id</td>
                                <td>
                                    <div class="fw-semibold">@(v.Name ?? "-")</div>
                                    <div class="small text-muted">@(v.Address ?? "-")</div>
                                </td>
                                <td>@(v.Email ?? "-")</td>
                                <td>@(v.Phone ?? "-")</td>
                                <td>@Html.Raw(Badge(v.Status ?? ""))</td>
                                <td>@(v.RegisteredAt == default ? "-" : v.RegisteredAt.ToString("yyyy-MM-dd"))</td>
                                <td>
                                    <span class="text-warning">@Stars(v.Rating)</span>
                                    <div class="small text-muted">@v.Rating.ToString("0.0") / 5</div>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                                       
                                        <button type="button" 
                                                class="btn btn-sm toggle-vendor-btn @(v.Status == "Active" ? "btn-warning" : "btn-success")"
                                                data-vendor-id="@v.Id"
                                                data-current-status="@(v.Status ?? "")">
                                            @(v.Status == "Active" ? "Disable" : "Active")
                                        </button>

                                     
                                        <button type="button"
                                                class="btn btn-info btn-sm"
                                                data-bs-toggle="modal"
                                                data-bs-target="#vendorModal"
                                                data-id="@v.Id"
                                                data-name="@(v.Name ?? "-")"
                                                data-email="@(v.Email ?? "-")"
                                                data-phone="@(v.Phone ?? "-")"
                                                data-address="@(v.Address ?? "-")"
                                                data-status="@(v.Status ?? "-")"
                                                data-registered="@(v.RegisteredAt == default ? "-" : v.RegisteredAt.ToString("yyyy-MM-dd"))"
                                                data-menu="@v.MenuItems"
                                                data-rating="@v.Rating">
                                            View
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    
    <div class="modal fade" id="vendorModal" tabindex="-1" aria-labelledby="vendorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="vendorModalLabel" class="modal-title">Vendor Detail</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-3">Vendor ID</dt>
                        <dd id="vd-id" class="col-sm-9"></dd>
                        <dt class="col-sm-3">Name</dt>
                        <dd id="vd-name" class="col-sm-9"></dd>
                        <dt class="col-sm-3">Email</dt>
                        <dd id="vd-email" class="col-sm-9"></dd>
                        <dt class="col-sm-3">Phone</dt>
                        <dd id="vd-phone" class="col-sm-9"></dd>
                        <dt class="col-sm-3">Status</dt>
                        <dd id="vd-status" class="col-sm-9"></dd>
                        <dt class="col-sm-3">Registered</dt>
                        <dd id="vd-registered" class="col-sm-9"></dd>
                        <dt class="col-sm-3">Address</dt>
                        <dd id="vd-address" class="col-sm-9"></dd>
                        <dt class="col-sm-3">Menu Items</dt>
                        <dd id="vd-menu" class="col-sm-9"></dd>
                        <dt class="col-sm-3">Rating</dt>
                        <dd id="vd-rating" class="col-sm-9"></dd>
                    </dl>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        <!-- DataTables (if already included in _Layout, avoid conflict by not including again) -->
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" />
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

        <script>
            let dt;
            $(function () {
                dt = $('#vendorsTable').DataTable({
                    pageLength: 10,
                    order: [[5, 'desc']], // Registered column descending
                    dom: 'lrtip'          // Hide default search box, use custom search
                });

                // Custom search
                $('#searchBox').on('keyup', function () {
                    dt.search(this.value).draw();
                });

                // Filtering (status column: column 4, rating column: column 6)
                $('#statusFilter, #ratingFilter').on('change', function () {
                    dt.columns().search('');

                    const status = $('#statusFilter').val();
                    const minRating = $('#ratingFilter').val();

                    if (status) dt.column(4).search(status, true, false);

                    if (minRating) {
                        // Rating text format "4.6 / 5", use simple range matching
                        const rx = minRating === '5'
                            ? '^\\s*5(\\.0)?\\s*/\\s*5\\s*$'
                            : `^[${minRating}-5](\\.[0-9])?\\s*/\\s*5\\s*$`;
                        dt.column(6).search(rx, true, false);
                    }

                    dt.draw();
                });

                // Reset filters
                $('#resetFilters').on('click', function () {
                    $('#searchBox').val('');
                    $('#statusFilter').val('');
                    $('#ratingFilter').val('');
                    dt.search('').columns().search('').draw();
                });

                // Modal handling
                const modal = document.getElementById('vendorModal');
                modal.addEventListener('show.bs.modal', function (event) {
                    const btn = event.relatedTarget;
                    const get = (k) => btn.getAttribute('data-' + k) || '-';
                    modal.querySelector('#vd-id').textContent = get('id');
                    modal.querySelector('#vd-name').textContent = get('name');
                    modal.querySelector('#vd-email').textContent = get('email');
                    modal.querySelector('#vd-phone').textContent = get('phone');
                    modal.querySelector('#vd-status').textContent = get('status');
                    modal.querySelector('#vd-registered').textContent = get('registered');
                    modal.querySelector('#vd-address').textContent = get('address');
                    modal.querySelector('#vd-menu').textContent = get('menu');
                    modal.querySelector('#vd-rating').textContent = get('rating') + ' / 5';
                });

                // Toggle vendor status
                $(document).on('click', '.toggle-vendor-btn', function() {
                    const btn = $(this);
                    const vendorId = btn.data('vendor-id');
                    const currentStatus = btn.data('current-status');
                    
                    if (!vendorId) {
                        alert('Invalid vendor ID');
                        return;
                    }

                    // Disable button to prevent duplicate clicks
                    btn.prop('disabled', true);
                    const originalText = btn.text();
                    btn.text('Processing...');

                    // Get anti-forgery token
                    const token = $('input[name="__RequestVerificationToken"]').val();

                    $.ajax({
                        url: '@Url.Action("ToggleVendor", "Admin")',
                        type: 'POST',
                        dataType: 'json',
                        cache: false,
                        data: {
                            id: vendorId,
                            __RequestVerificationToken: token
                        },
                        success: function(response) {
                            const isSuccess = response && (response.success === true || response.success === 'true' || response.success == true);
                            if (isSuccess) {
                               
                                showToast(response.message || 'Operation succeeded', 'success');
                                window.location.reload();
                            } else {
                                showToast(response?.message || 'Operation failed', 'error');
                                btn.prop('disabled', false);
                                btn.text(originalText);
                            }
                        },
                        error: function() {
                            showToast('Network error, please try again later', 'error');
                            btn.prop('disabled', false);
                            btn.text(originalText);
                        },
                        complete: function() {
                            
                            setTimeout(function() {
                                try { if (!document.hidden) window.location.reload(); } catch (_) { /* noop */ }
                            }, 800);
                        }
                    });
                });

                // Function to show toast messages
                function showToast(message, type) {
                    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
                    const toastHtml = `
                        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                    
                    // Remove existing alerts
                    $('.alert').remove();
                    
                    // Add new alert to top of page
                    $('.container').prepend(toastHtml);
                    
                    // Auto-hide after 3 seconds
                    setTimeout(function() {
                        $('.alert').fadeOut();
                    }, 3000);
                }
            });
        </script>
    }
