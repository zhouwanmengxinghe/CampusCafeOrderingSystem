@model IEnumerable<ReviewViewModel>
 

        @{
    ViewData["Title"] = "Review Center";

    string Stars(int r) => new string('★', Math.Clamp(r,1,5)) + new string('☆', Math.Clamp(5-r,0,5));
    string Badge(string status) => status switch
    {
        "Approved" => "<span class=\"badge bg-success\">Approved</span>",
        "Rejected" => "<span class=\"badge bg-danger\">Rejected</span>",
        _ => "<span class=\"badge bg-secondary\">Pending</span>"
    };
        }

        <h2 class="mb-4 text-center">?? Review Center</h2>

        @if (TempData["Toast"] is string toast && !string.IsNullOrWhiteSpace(toast))
{
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            @toast
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
}

        <!-- 顶部筛选 -->
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Keyword</label>
                        <input id="searchBox" type="text" class="form-control" placeholder="Search by customer or comment">
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">Min Rating</label>
                        <select id="ratingFilter" class="form-select">
                            <option value="">All</option>
                            <option value="1">≥ 1</option>
                            <option value="2">≥ 2</option>
                            <option value="3">≥ 3</option>
                            <option value="4">≥ 4</option>
                            <option value="5">= 5</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">Status</label>
                        <select id="statusFilter" class="form-select">
                            <option value="">All</option>
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-2 text-md-end">
                        <button id="resetFilters" class="btn btn-outline-secondary w-100">Reset</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 列表 -->
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="reviewTable" class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th style="width:90px;">ID</th>
                                <th style="min-width:140px;">Customer</th>
                                <th>Comment</th>
                                <th style="width:120px;">Rating</th>
                                <th style="width:130px;">Date</th>
                                <th style="width:120px;">Status</th>
                                <th style="width:180px;" class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var r in Model)
                {
                    var isPending = r.Status == "Pending";
                            <tr>
                                <td>@r.Id</td>
                                <td>@r.CustomerName</td>
                                <td>
                                    <div class="text-truncate" style="max-width:460px;" title="@r.Comment">@r.Comment</div>
                                    <button type="button"
                                            class="btn btn-link p-0 small"
                                            data-bs-toggle="modal"
                                            data-bs-target="#commentModal"
                                            data-id="@r.Id"
                                            data-customer="@r.CustomerName"
                                            data-comment="@r.Comment">
                                        View full
                                    </button>
                                </td>
                                <td>
                                    <span class="text-warning">@Stars(r.Rating)</span>
                                    <div class="small text-muted">@r.Rating / 5</div>
                                </td>
                                <td>@r.CreatedAt.ToString("yyyy-MM-dd")</td>
                                <td>@Html.Raw(Badge(r.Status))</td>
                                <td class="text-center">
                                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                                        <form asp-action="ModerateReview" asp-controller="Admin" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@r.Id" />
                                            <input type="hidden" name="decision" value="Approve" />
                                            <button type="submit" class="btn btn-success btn-sm" @(isPending ? "" : "disabled")>Approve</button>
                                        </form>
                                        <form asp-action="ModerateReview" asp-controller="Admin" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@r.Id" />
                                            <input type="hidden" name="decision" value="Reject" />
                                            <button type="submit" class="btn btn-danger btn-sm" @(isPending ? "" : "disabled")>Reject</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 查看全文 Modal -->
        <div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 id="commentModalLabel" class="modal-title">Review Detail</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-3">ID</dt>
                            <dd id="md-id" class="col-sm-9"></dd>

                            <dt class="col-sm-3">Customer</dt>
                            <dd id="md-customer" class="col-sm-9"></dd>

                            <dt class="col-sm-3">Comment</dt>
                            <dd id="md-comment" class="col-sm-9"></dd>
                        </dl>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        @section Scripts {
            <!-- DataTables -->
            <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" />
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
            <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

            <script>
                // DataTable 初始化
                let dt;
                $(function () {
                    dt = $('#reviewTable').DataTable({
                        pageLength: 10,
                        order: [[4, 'desc']], // 按日期倒序
                        dom: 'lrtip' // 隐藏默认搜索框，使用自定义搜索
                    });

                    // 自定义搜索与筛选
                    $('#searchBox').on('keyup', function () {
                        dt.search(this.value).draw();
                    });

                    $('#ratingFilter, #statusFilter').on('change', function () { applyFilters(); });

                    $('#resetFilters').on('click', function () {
                        $('#searchBox').val('');
                        $('#ratingFilter').val('');
                        $('#statusFilter').val('');
                        dt.search('').draw();
                        dt.columns().search('').draw();
                    });

                    function applyFilters() {
                        const minRating = $('#ratingFilter').val();
                        const status = $('#statusFilter').val();

                        // 先重置列搜索
                        dt.columns().search('');

                        // Status 在第 5 列（从 0 开始：0..6）
                        if (status) dt.column(5).search(status, true, false);

                        // Rating 在第 3 列，列文本包含 "★"；这里用数字列筛选更稳妥――我们在 small 文本里有 "x / 5"
                        if (minRating) dt.column(3).search(`^(${minRating}|${minRating}\\s\\/\\s5|[${minRating}-5])`, true, false);

                        dt.draw();
                    }

                    // Modal 填充
                    var commentModal = document.getElementById('commentModal');
                    commentModal.addEventListener('show.bs.modal', function (event) {
                        const btn = event.relatedTarget;
                        const id = btn.getAttribute('data-id');
                        const customer = btn.getAttribute('data-customer');
                        const comment = btn.getAttribute('data-comment');

                        commentModal.querySelector('#md-id').textContent = id;
                        commentModal.querySelector('#md-customer').textContent = customer;
                        commentModal.querySelector('#md-comment').textContent = comment;
                    });
                });
            </script>
        }
